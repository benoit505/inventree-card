# Card ID Stability Roadmap

## 1. The Problem: Unstable Card IDs

We've identified a critical flaw in our persistence logic: the `cardInstanceId`, which is used to key all persisted state in `localStorage` (via Redux Persist), is not stable across page reloads.

The root cause is a feedback loop:
1.  The `cardInstanceId` is generated by hashing the card's `config` object.
2.  When a user saves a custom layout, those changes (`layout_overrides`) are saved into the Redux store as part of the `config` object for that card instance.
3.  On page reload, Home Assistant sometimes provides a `config` object to the `setConfig` method that has been influenced by our own persisted state.
4.  This "dirty" config object, now containing `layout_overrides`, produces a **different hash** than the original "clean" config.
5.  A new, different `cardInstanceId` is generated.
6.  The application then tries to find persisted state for this new ID and finds nothing, causing the user's saved layout to be lost.

## 2. The Solution: Clean Configuration Hashing

The fix is to ensure that the `cardInstanceId` is *always* generated from a "clean", predictable version of the configuration, free from any dynamic state we might have added.

### Implementation Steps

-   **Modify `inventree-card.ts`:**
    -   In the `setConfig` method, where the ID is generated, we will first create a deep copy of the incoming `config` object.
    -   From this temporary copy, we will **delete** the `layout.layout_overrides` property if it exists.
    -   We will then `JSON.stringify` and hash this "cleaned" config object to generate the ID.
    -   Add verbose console logging to show the exact object being hashed, which will help verify the fix.

This ensures that the ID is based *only* on the static configuration defined in the user's `ui-lovelace.yaml`, making it stable and reliable for retrieving persisted state.

## 3. Verification

-   After the fix is applied, load the card. Note the generated `cardInstanceId` in the console.
-   Edit and save the layout.
-   Reload the page.
-   Verify that the generated `cardInstanceId` in the console is **identical** to the one from before the reload.
-   Verify that the saved layout is correctly restored.


