import{L as e,s as t,a,b as r,c as i,i as s,d as n}from"./inventree-card.js";const o=e.getInstance(),c=e=>{switch(e.toLowerCase()){case"highlight":case"backgroundcolor":return"highlight";case"textcolor":case"color":return"textColor";case"border":return"border";case"icon":return"icon";case"badge":return"badge";case"opacity":return"opacity";case"priority":return"priority";default:const t=e,a={isVisible:!0};return Object.keys(a).includes(t)?t:null}};class l{constructor(e,t){this.dispatch=e,this.getState=t,o.log("ConditionalEffectsEngine","Engine initialized.")}async evaluateAndApplyEffects(){var e,l,u;const p=this.getState(),f=t(p),d=p.parts.partsById,g=p.config.hass,y=p.genericHaStates;if(o.log("[ConditionalEffectsEngine]","evaluateAndApplyEffects - START.",{processedConditionsCount:f.length}),!f||0===f.length)return void this.dispatch(a({}));const b={},m=(e,t)=>{b[e]=Object.assign(Object.assign({},b[e]||{}),t)};for(const t of f){let a=!1;const f=t.originalRule;let b,h=[];if("*"===f.targetPartIds?h=Object.keys(d).map((e=>parseInt(e,10))).filter((e=>!isNaN(e))):Array.isArray(f.targetPartIds)?h=f.targetPartIds.filter((e=>"number"==typeof e&&!isNaN(e))):"number"==typeof t.partId&&(h=[t.partId]),("inventree_parameter"===t.sourceType||"inventree_attribute"===t.sourceType)&&"number"!=typeof t.partId){o.warn("CEE",`Skipping part-specific condition (ID: ${t.id}) due to missing partId.`,{rule:f});continue}switch(t.sourceType){case"inventree_parameter":if("number"==typeof t.partId&&t.parameterName){const a=null===(e=s.endpoints.getPartParameters.select(t.partId)(p))||void 0===e?void 0:e.data;b=null===(l=null==a?void 0:a.find((e=>{var a;return(null===(a=e.template_detail)||void 0===a?void 0:a.name)===t.parameterName})))||void 0===l?void 0:l.data}break;case"inventree_attribute":"number"==typeof t.partId&&t.attributeName&&(b=null===(u=d[t.partId])||void 0===u?void 0:u[t.attributeName]);break;case"ha_entity_state":t.entityId&&(b=i(p,t.entityId));break;case"ha_entity_attribute":t.entityId&&t.haAttributeName&&(b=r(p,t.entityId,t.haAttributeName));break;default:b=void 0}const v=String(f.operator);let E=v;if("="===v?E="equals":"!="===v?E="not_equals":">"===v?E="greater_than":"<"===v&&(E="less_than"),null==b)switch(E){case"exists":a=!1;break;case"is_empty":a=!0;break;default:a="equals"===E&&(null===f.value||""===f.value)||"not_equals"===E&&null!==f.value&&""!==f.value}else switch(E){case"equals":a=String(b)===String(f.value);break;case"not_equals":a=String(b)!==String(f.value);break;case"contains":a=String(b).includes(String(f.value));break;case"exists":a=""!==String(b).trim();break;case"is_empty":a=""===String(b).trim();break;case"greater_than":const e=parseFloat(String(b)),t=parseFloat(String(f.value));a=!isNaN(e)&&!isNaN(t)&&e>t;break;case"less_than":const r=parseFloat(String(b)),i=parseFloat(String(f.value));a=!isNaN(r)&&!isNaN(i)&&r<i;break;default:o.warn("CEE",`Unhandled operator '${E}' for rule.`,{rule:f}),a=!1}if(a&&(o.log("CEE",`Condition TRUE (ID: ${t.id}, RuleParam: ${f.parameter}). Applying effects.`,{baseTargetPartPks:h}),t.effects&&Array.isArray(t.effects)))for(const e of t.effects){let t=h;e.targetPartPks&&("all_loaded"===e.targetPartPks?t=Object.keys(d).map((e=>parseInt(e,10))).filter((e=>!isNaN(e))):Array.isArray(e.targetPartPks)?t=e.targetPartPks.filter((e=>"number"==typeof e&&!isNaN(e))):"string"==typeof e.targetPartPks&&(t=e.targetPartPks.split(",").map((e=>parseInt(e.trim(),10))).filter((e=>!isNaN(e)))));for(const a of t){if("number"!=typeof a||isNaN(a))continue;const t=d[a];if(t||"trigger_custom_action"!==e.type&&"set_style"!==e.type&&"set_visibility"!==e.type)switch(e.type){case"set_style":if(e.styleProperty&&void 0!==e.styleValue){const t=c(e.styleProperty);t&&m(a,{[t]:e.styleValue})}break;case"set_visibility":"boolean"==typeof e.isVisible?m(a,{isVisible:e.isVisible}):(o.warn("CEE",`Effect 'set_visibility' for PK ${a} used non-boolean isVisible. EffectDef:`,{effect:e}),m(a,{isVisible:"show"===e.value}));break;case"trigger_custom_action":if(e.customActionId){o.log("CEE",`Triggering custom action ID: ${e.customActionId} for part PK: ${a}`);const r={part:t,hass:g,hassStates:y};n.executeAction(e.customActionId,r).catch((t=>{o.error("CEE",`Error executing action ${e.customActionId} from condition`,{pk:a,actionError:t})}))}break;default:o.warn("CEE",`Unknown effect type: ${e.type}`,{effect:e})}else o.warn("CEE",`Part PK ${a} not found. Skipping effect.`,{effectType:e.type})}}}this.dispatch(a(b)),o.log("[ConditionalEffectsEngine]","evaluateAndApplyEffects - END.",{appliedEffectsCount:Object.keys(b).length})}}export{l as ConditionalEffectsEngine};
//# sourceMappingURL=ConditionalEffectsEngine-0bc00221.js.map
